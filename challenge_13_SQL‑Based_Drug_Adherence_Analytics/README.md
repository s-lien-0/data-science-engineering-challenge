# Drug Adherence Analytics (Challenge 13)

Analyse prescription-refill behaviour for a pharmacy chain using **PostgreSQL 14 + SQLAlchemy 2.x**.  
The pipeline ingests a CSV, persists it to Postgres, then answers four business questions:

1. Average refill interval per patient  
2. Late-refill flags (> 30 days Ã— 1.20)  
3. Top three drugs by refill count  
4. *Bonus* â€“ adherence rate per drug visualised as a bar chart

---

## ðŸ›  Tech stack

| Layer            | Choice                         | Why                                |
|------------------|--------------------------------|------------------------------------|
| Database         | PostgreSQLÂ 14 (Docker image)   | Ubiquitous in prod & interview tests |
| Python ORM/Core  | SQLAlchemyÂ 2.xÂ +Â psycopg2      | Mostâ€‘requested ORM in EU job ads    |
| Migrations       | Alembicâ€¯â‰¥â€¯1.13Â (optional)      | Shows you can version schemas       |
| Data handling    | pandas                         | Convenient CSV I/O & DataFrame view |
| Plotting         | matplotlib                     | Standard lib for quick bar chart    |

---

## âš¡ Quickâ€‘start (5Â minutes)

### 1Â Â Clone & enter the project

```bash
git clone <yourâ€‘forkâ€‘url> drugâ€‘adherence && cd drugâ€‘adherence
```

### 2Â Â Boot PostgreSQL in Docker

```bash
docker compose up -d db               # pulls & starts postgres:14
```
The container exposes **portâ€¯5432** locally and creates a database `refills` with user `postgres` / password `postgres`.

### 3Â Â Create & activate a virtualenv

```bash
python -m venv .venv && source .venv/bin/activate
```

### 4Â Â Install Python dependencies

```bash
pip install -r requirements.txt
```

### 5Â Â Export the connection URL

```bash
export DATABASE_URL="postgresql+psycopg2://postgres:postgres@localhost:5432/refills"
```
*(Fish/zsh users: adjust syntax or add to an `.env` file.)*

### 6Â Â Initialise the schema *(optional but recommended)*

```bash
alembic upgrade head                  # generates table `refills`
```

### 7Â Â Run the pipeline

```bash
python drug_adherence.py refills.csv
```

#### Expected output

```text
Average refill interval per patient
+------------+--------------+
| patient_id | avg_interval |
+------------+--------------+
| Pâ€‘0001     | 29.7         |
| â€¦          | â€¦            |

Lateâ€‘refill flags (is_late = 1)
â€¦
Top three drugs by refill count
â€¦
Saved chart â†’ adherence_by_drug.png
```

---

## ðŸ”§ Configuration

Edit **`settings.py`** to tweak business rules:

```python
DEFAULT_INTERVAL_DAYS = 30    # expected days between refills
GRACE_PERCENT          = 0.20 # 20â€¯% grace period for late flag
```

---

## ðŸ“‘ Project structure

```text
.
â”œâ”€â”€ alembic/                 # versionâ€‘controlled migrations
â”‚Â Â  â””â”€â”€ versions/            # autogenerated revision files
â”œâ”€â”€ docker-compose.yml       # spins up PostgreSQLÂ 14 in one command
â”œâ”€â”€ drug_adherence.py        # main entrypoint â€“ ingest, analyse, output
â”œâ”€â”€ db.py                    # engine + session factory
â”œâ”€â”€ models.py                # SQLAlchemy Declarative models (Refill)
â”œâ”€â”€ settings.py              # tweak lateâ€‘refill threshold & interval
â”œâ”€â”€ requirements.txt         # dependencies (sqlalchemy, pandasâ€¦)
â”œâ”€â”€ refills.csv              # sample data (replace with real file)
â””â”€â”€ README.md                # you are here
```

---

## ðŸš‘ Troubleshooting

| Symptom                                         | Fix                                                         |
|-------------------------------------------------|-------------------------------------------------------------|
| `psycopg2.OperationalError: could not connect`  | Docker not running? Run `docker compose up -d db`.          |
| `alembic: command not found`                    | `pip install alembic` inside virtualenv.                    |
| CSV ingestion fails                             | Check file path; ensure header columns match the schema.    |
| Plot shows garbled characters                   | On macOS: `export LC_ALL=en_US.UTF-8`.                      |

---

## ðŸ§¹ Cleanup

```bash
docker compose down -v     # stop & delete Postgres container & data volume
rm -rf .venv               # remove virtualenv
```